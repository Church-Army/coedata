# WARNING - Generated by {fusen} from dev/flat_reading-coe-statistics.Rmd: do not edit by hand

#' Get census data for the Church of England at a parish, diocesan or national level.
#'
#' @return A [tibble::tibble()] containing census data for the Church of England  
#' @param ons_id The ONS id of required data. Must be one of [coe_datasets()].
#' @param level The geographical level at which data are required. Must be one of 'parish', 'diocese' or 'england'.
#' @param areas A character vector of parish codes or diocese numbers. If specified, the returned tibble will contain only data for these areas. Cannot be used with `level = 'england'`. `NA` values will be removed.
#' @param relative Logical. Should returned table contain absolute statitiscs (e.g. persons/households) or proportions for each area?
#' @export 
#'
#' @examples
#' coe_census(ons_id =  "TS001", level = "england")
#' coe_census(ons_id = "TS001", level = "diocese", areas = 1)
coe_census <- function(ons_id, level, areas, relative = FALSE){
  
  ## Validate inputs
  
  ### Check ons_id is character vector with length one
  if(!is.character(ons_id) || length(ons_id) != 1) rlang::abort("Argument ons_id must be a character vector with length 1", class = "coe_bad_ons_id")
  
  ### Check ons_id's are all good
  if(!all(ons_id %in% good_ons_ids())){
    
    rlang::abort(c("Argument ons_id pertains to data that is not available through this package:", ons_id),
                 class = "coe_bad_ons_id")
  }
  
  ### level must be length 1
  if(length(level) != 1 || !is.character(level)) rlang::abort("Argument 'level' must be a character vector with length 1.",
                                                              class = "coe_bad_level")
  
  ### Check level are all good
  if(!all(level %in% good_levels())){
    good_level_txt <-
      as.character(good_levels()) |> 
      paste0("\"", foo = _, "\"")
    
    good_level_text <- paste0("c(", paste(good_level_txt, collapse = ", "), ")") 
    
    rlang::abort(c(
      paste("Argument 'level' must be one of: ", good_level_text),
      `!` = "Problematic argument:",
      `x` = paste0("level = ", level)),
      class = "coe_bad_level")
  }
  
  ## Validate areas
  ### No missing values
  if(!rlang::is_missing(areas) && any(is.na(areas))){
    rlang::warn("Ignoring missing values in argument 'areas'", class = "coe_warn_areas")
    areas <- areas[!is.na(areas)]
  }
  
  ## Get data
  out <- read_cpd_stats(ons_id, level)

  if(!rlang::is_missing(areas)){
    if(level == "parish")  out <- out[out$parish_code %in% areas, ]
    if(level == "diocese") out <- out[out$diocese_number %in% areas, ]
    if(level == "england") rlang::abort("Argument 'areas' provided but can not be used with level = 'england'",
                                        class = "coe_areas_with_england")
  }
  
  if(relative) out <- cpd_relative(out)
  
  out
}
